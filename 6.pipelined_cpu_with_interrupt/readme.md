# 流水线CPU的精准中断

流水线CPU中与单周期CPU相同，考虑一个外部中断和三个异常。

其中外部中断可能会发生在流水线过程中的任意级别。

syscall指令和系统位实现指令引起的异常发生在ID级，算术操作结果溢出导致的异常发生在EXE级。

与CPU处理异常事件和中断有关的3个寄存器。

Cause：增加BD位，如果引起异常事件的指令时在转移或跳转指令的延迟槽中，该位置1。如果有外部请求时，在流水线ID级的指令是处在延迟槽中，ID也需要置1。其他情况下BD位清0。

Status：

EPC：中断时保存返回地址，异常时保存引起异常的指令的地址。（如果引起异常的指令在延迟槽中，则EPC保存延迟转移指令的地址。）



需要：

1.判断出一条指令是否在延迟槽中。（is_branch信号）

2.当异常或中断发生时，我们需要报废后续指令甚至当前指令。（cancel信号）

## 外部中断来临时的三种情况

外部中断带来时需要分三种情况进行分析。

1.ID级执行转移指令时来了中断

将转移指令的地址写入EPC，异常和中断处理程序的入口地址BASE写入PC。并在ID级产生cancel信号废除下一条（处在延迟槽的）指令。（中断返回时将重新执行转移指令）

2.ID级时延迟槽时来了中断

让延迟槽执行完。EPC中写入延迟槽上方转移指令计算出的转移目的地址。e_cancel取消转移目标地址的指令。设置BD为1。（BD为1的目的？后续在哪里用到？）

3.其他情况下来了中断

在ID级响应中断，废弃下一条指令。下一条指令的地址写入EPC。

## 流水线CPU处理异常事件

引起异常事件的指令的地址写入EPC。（异常返回时还继续指令引起异常的指令？？？）

如果该指令处在延迟槽中，把它上面的转移指令或跳转指令的地址写入EPC中，并把BD置1。

### 系统调用syscall

不需要考虑指令在延迟槽的情况。

EPC保存syscall指令的地址PCD。

PCD、PCE、PC的区别？分别表示什么含义？（PCD表示当前处在ID周期的指令的地址，PCE表示当前处在EXE周期的指令的地址，PC表示当前处在取值周期的指令的地址？）

在ID级转到异常并废弃它下面的指令。

### 未实现的指令unimpl

#### 未实现指令在延迟槽中

EPC保存未实现指令上面那条转移指令的地址。Cause寄存器中BD位置1。

#### 未实现指令没有在延迟槽中

EPC中保存本条未实现指令的地址。

### 算术结果溢出

需要在EXE级封锁wreg信号。ID级的指令要放弃执行。

#### 算术结果溢出发生在延迟槽中

EPC中保存它上面的转移指令的地址PCM。Cause寄存器中的BD位要置1。

#### 算术结果溢出没有发生在延迟槽中

一般情况下，EPC保存的是引起算术结果溢出的指令地址。



课本上关于流水线中断处理的代码没有进行详细的模块划分，它将所有的代码都堆在了CPU模块中。

所以这部分代码暂时还没有实现。后续过程再进行整理。

